<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>Gestión de Cuotas</title>
    <style>
        .paid {
            background-color: #d4edda;
        }
        .not-paid {
            background-color: #f8d7da;
        }
    </style>
</head>
<body>

    <h1>Gestión de Cuotas</h1>

    <!-- Filtros para año y rol -->
    <div class="filters">
        <label for="year-select">Año:</label>
        <select id="year-select" onchange="cargarUsuarios(this)">            
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
            <option value="2031">2031</option>
            <option value="2032">2032</option>
            <option value="2033">2033</option>
            <option value="2034">2034</option>
        </select>

        <label for="role-select">Rol:</label>
        <select id="role-select" onchange="filterData()">
            <option value="all">Todos</option>
            <option value="socio propietario">Socio Propietario</option>
            <option value="socio deportista">Socio Deportista</option>
        </select>
        <label for="user-filter">Usuario:</label>
        <input type="text" id="user-filter" onkeyup="filterByUser()" placeholder="Buscar por nombre de usuario">
    </div>

    <table id="cuotas-table" class="has-text-color has-link-color" style="color:#1e73be">
        <thead>
            <tr>
                <th class="has-text-align-center">Usuario</th>
                <th class="has-text-align-center">Rol</th>
                <th class="has-text-align-center">Enero</th>
                <th class="has-text-align-center">Febrero</th>
                <th class="has-text-align-center">Marzo</th>
                <th class="has-text-align-center">Abril</th>
                <th class="has-text-align-center">Mayo</th>
                <th class="has-text-align-center">Junio</th>
                <th class="has-text-align-center">Julio</th>
                <th class="has-text-align-center">Agosto</th>
                <th class="has-text-align-center">Septiembre</th>
                <th class="has-text-align-center">Octubre</th>
                <th class="has-text-align-center">Noviembre</th>
                <th class="has-text-align-center">Diciembre</th>
            </tr>
        </thead>
        <tbody id="cuotas-table-body">
        </tbody>
    </table>

    <script>
        var api_url = "https://club-padel-api-12f28391bbbd.herokuapp.com";

        function filterByUser() {
            const input = document.getElementById('user-filter');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('cuotas-table');
            const rows = table.getElementsByTagName('tr');
            

            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                const userName = cells[0].textContent || cells[0].innerText;
                if (userName.toLowerCase().indexOf(filter) > -1) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }

        function removePayment(button) {
            const cell = button.parentElement;
            cell.classList.add('not-paid');
            cell.classList.remove('paid');
            cell.innerHTML = `<select>
                                <option value="CONTADO">Contado</option>
                                <option value="TARJETA">Tarjeta</option>
                            </select>
                            <button onclick="markPaid(this)">Pagar</button>`;
        }
        // Simular marcado de pago
        function markPaid(button) {
            const td = button.parentElement;
            const select = td.querySelector('select');
            const metodoPago = select.value;  // Obtener el método de pago seleccionado
            
            // Comprobamos si se ha seleccionado un método de pago
            if (!metodoPago) {
                alert("Por favor, selecciona un método de pago.");
                return;
            }

            var currentDate = new Date();
            const mm = String(currentDate.getMonth() + 1).padStart(2, '0');
            const dd = String(currentDate.getDate()).padStart(2, '0');
            const yyyy = currentDate.getFullYear();
            const dia = `${dd}/${mm}/${yyyy}`;

            td.classList.remove('not-paid');
            td.classList.add('paid');
            td.innerHTML = `Pagado (${metodoPago})</br>${dia}</br>            
                            <button onclick="removePayment(this)">Eliminar Pago</button>`;
        }

        // Filtro por año y rol
        function filterData() {
            const selectedRole = document.getElementById('role-select').value;
            
            // Filtrar las filas de la tabla
            const rows = document.querySelectorAll('#cuotas-table tbody tr');
            rows.forEach(row => {
                const role = row.getAttribute('data-role');
                if (selectedRole === 'all' || role === selectedRole) {
                    row.style.display = ''; // Mostrar
                } else {
                    row.style.display = 'none'; // Ocultar
                }
            });

        }

        function cargarUsuarios(yearSelect) {
            const tbody = document.getElementById('cuotas-table-body').innerHTML = '';
            const year = yearSelect.value;
            
            $.ajax({
                url: api_url+'/usuarios/buscar-por-roles?roles=socio propietario,socio deportista',
                type: 'GET',
                contentType: 'application/json',
                headers: {
                                'Content-Type' : 'application/json',
                                'Authorization': 'Basic Y2x1YnBhZGVsdXNlcjpjbHVicGFkZWxwYXNz'
                        },         
                success: function(data) {
                    const tbody = document.getElementById('cuotas-table-body');
                    $.each(data, function(index, user) {
                        const row = document.createElement('tr');
                        row.dataset.class='has-text-align-center';
                        row.dataset.rolId = user.rolId; 
                        row.dataset.role = user.rolName;
                        row.dataset.userId = user.userId; 
                        row.dataset.uername = user.username;
                        row.dataset.cuotaMensual = user.cuotaMensual;

                        row.innerHTML = `
                            <td>${user.username}</td>
                            <td>${user.rolName}</td>
                            <td class="not-paid"><select><option value="CONTADO">Contado</option><option value="TARJETA">Tarjeta</option></select><button onclick="markPaid(this)">Pagar</button></td>
                            <td class="not-paid"><select><option value="CONTADO">Contado</option><option value="TARJETA">Tarjeta</option></select><button onclick="markPaid(this)">Pagar</button></td>
                            <td class="not-paid"><select><option value="CONTADO">Contado</option><option value="TARJETA">Tarjeta</option></select><button onclick="markPaid(this)">Pagar</button></td>
                            <td class="not-paid"><select><option value="CONTADO">Contado</option><option value="TARJETA">Tarjeta</option></select><button onclick="markPaid(this)">Pagar</button></td>
                            <td class="not-paid"><select><option value="CONTADO">Contado</option><option value="TARJETA">Tarjeta</option></select><button onclick="markPaid(this)">Pagar</button></td>
                            <td class="not-paid"><select><option value="CONTADO">Contado</option><option value="TARJETA">Tarjeta</option></select><button onclick="markPaid(this)">Pagar</button></td>
                            <td class="not-paid"><select><option value="CONTADO">Contado</option><option value="TARJETA">Tarjeta</option></select><button onclick="markPaid(this)">Pagar</button></td>
                            <td class="not-paid"><select><option value="CONTADO">Contado</option><option value="TARJETA">Tarjeta</option></select><button onclick="markPaid(this)">Pagar</button></td>
                            <td class="not-paid"><select><option value="CONTADO">Contado</option><option value="TARJETA">Tarjeta</option></select><button onclick="markPaid(this)">Pagar</button></td>
                            <td class="not-paid"><select><option value="CONTADO">Contado</option><option value="TARJETA">Tarjeta</option></select><button onclick="markPaid(this)">Pagar</button></td>
                            <td class="not-paid"><select><option value="CONTADO">Contado</option><option value="TARJETA">Tarjeta</option></select><button onclick="markPaid(this)">Pagar</button></td>
                            <td class="not-paid"><select><option value="CONTADO">Contado</option><option value="TARJETA">Tarjeta</option></select><button onclick="markPaid(this)">Pagar</button></td>
                        `;
                        tbody.appendChild(row);
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error al añadir un nuevo rol:', error);
                }
            });

        }

        cargarUsuarios(document.getElementById('year-select'));

    </script>

</body>
</html>
